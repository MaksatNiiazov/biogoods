function getDateTime(){const t=new Date;return t.toLocaleString()+"GMT "+(-t.getTimezoneOffset()<0?"-":"+")+Math.abs(t.getTimezoneOffset()/60)}function SimpleChatbot(t){if(!t.root)throw"SimpleChatbot: ключ root должен присутствовать в передаваемых данных";if(this._$root=t.root,!t.replicas)throw"SimpleChatbot: ключ replicas должен присутствовать в передаваемых данных";this._replicas=t.replicas,this._url=t.url||"/chatbot/chatbot.php",this._key=t.key||"fingerprint",this._delay=500,this._botIndex=0,this._contentIndex=1,this._start=!0,this._params={},this._active=!1,this._addEventListener()}Element.prototype.matches||(Element.prototype.matches=Element.prototype.msMatchesSelector||Element.prototype.webkitMatchesSelector),Element.prototype.closest||(Element.prototype.closest=function(t){let e=this;do{if(Element.prototype.matches.call(e,t))return e}while(e=e.parentElement||e.parentNode,null!==e&&1===e.nodeType);return null}),SimpleChatbot.prototype.init=function(){if(!this._active){this._active=!0;var o=localStorage.getItem("chatbot");if(o){var a=JSON.parse(o);this._params=a.params,this._botIndex=a.botIndex;let t=[],e=0;for(;e<a.data.length;)t.push(SimpleChatbot.templateItem(a.data[e])),e++;this._$root.querySelector(".chatbot__items").insertAdjacentHTML("beforeend",t.join("")),this._outputContent(0)}else this._outputContent(this._delay)}},SimpleChatbot.prototype.reset=function(){SimpleChatbot.resetTemplate(),this._botIndex=0,this._contentIndex=1,this._start=!0,this._params={},this._active=!1,localStorage.removeItem("chatbot"),this.init()},SimpleChatbot.prototype._template=function(t,e,o){o=2<arguments.length&&void 0!==arguments[2]?arguments[2]:"";return'<div class="chatbot__item chatbot__item_'.concat(t,'"><div class="chatbot__content chatbot__content_').concat(t,o,'">',e,"</div></div>")},SimpleChatbot.prototype._templateBtn=function(t,e){return'<button class="btn" type="button" data-bot-index="'+t+'">'+e+"</button>"},SimpleChatbot.prototype._getData=function(t,e){return this._replicas[t][e.toString()]},SimpleChatbot.prototype._outputContent=function(t){var e=this._getData("bot",this._botIndex),o=e.human,a=this._$root.querySelector(".chatbot__items"),n=e.content;if(Array.isArray(n)){for(var s=0,i=(n=n.slice()).length;s<i;s++)if(-1!==n[s].indexOf("{{"))for(var r in this._params)n[s]=n[s].split("{{".concat(r,"}}")).join(this._params[r])}else if(-1!==n.indexOf("{{"))for(var c in this._params)n=n.split("{{".concat(c,"}}")).join(this._params[c]);function l(){var t;""===_._getData("human",o[0]).content?(_._$root.querySelector(".chatbot__input").disabled=!1,_._$root.querySelector(".chatbot__input").dataset.name=_._getData("human",o[0]).name,_._$root.querySelector(".chatbot__submit").disabled=!0,_._$root.querySelector(".chatbot__input").focus(),_._$root.querySelector(".chatbot__submit").dataset.botIndex=_._getData("human",o[0]).bot):(_._$root.querySelector(".chatbot__input").value="",_._$root.querySelector(".chatbot__input").disabled=!0,_._$root.querySelector(".chatbot__submit").disabled=!0,t=o.map(function(t){t=_._getData("human",t);return _._templateBtn(t.bot,t.content)}),t=_._template("human",t.join("")),a.insertAdjacentHTML("beforeend",t),a.scrollTop=a.scrollHeight)}var _=this;if(t){var h=1;if(Array.isArray(n))for(s=0,i=n.length;s<i;s++){var p=this._template("bot",n[s]);window.setTimeout(function(){a.insertAdjacentHTML("beforeend",p),a.scrollTop=a.scrollHeight},t*h),h++}else{var b=this._template("bot",n);window.setTimeout(function(){a.insertAdjacentHTML("beforeend",b),a.scrollTop=a.scrollHeight},t*h),h++}window.setTimeout(function(){l()},t*h)}else{if(Array.isArray(n))for(s=0,i=n.length;s<i;s++){var d=this._template("bot",n[s]);a.insertAdjacentHTML("beforeend",d),a.scrollTop=a.scrollHeight}else{e=this._template("bot",n);a.insertAdjacentHTML("beforeend",e),a.scrollTop=a.scrollHeight}l()}},SimpleChatbot.prototype._humanResponseToDisabled=function(t){var e=t.closest(".chatbot__content_human"),t=t.innerHTML;return e.innerHTML=t,e.classList.remove("chatbot__content_human"),e.classList.add("chatbot__content_human-disabled"),t},SimpleChatbot.prototype._addToChatHumanResponse=function(t){var e=this._$root.querySelector(".chatbot__items"),t=this._template("human",t,"-disabled");e.insertAdjacentHTML("beforeend",t),e.scrollTop=e.scrollHeight},SimpleChatbot.prototype._eventHandlerClick=function(t){var e=t.target,o=e.dataset.botIndex,a=this._url,n={},s="",i="";if(e.closest(".chatbot__submit")){if(e.closest(".chatbot__submit").disabled)return;if(e.closest(".chatbot__submit").disabled=!0,!this._$root.querySelector(".chatbot__input").value.length)return;this._botIndex=+e.closest(".chatbot__submit").dataset.botIndex,s=this._$root.querySelector(".chatbot__input").value,(i=this._$root.querySelector(".chatbot__input").dataset.name)&&(this._params[i]=s),this._addToChatHumanResponse(s),this._outputContent(this._delay)}else{if(!o)return e.classList.contains("chatbot__close")?(e.closest(".chatbot").classList.add("chatbot_hidden"),void document.querySelector(".chatbot__btn").classList.remove("d-none")):e.classList.contains("chatbot__reset")?void this.reset():void 0;this._botIndex=+o,s=this._humanResponseToDisabled(e),this._outputContent(this._delay)}t.preventDefault();for(var e=document.querySelectorAll(".chatbot__item_bot"),r=e[e.length-1],c=r;r&&r.classList.contains("chatbot__item_bot");)r=(c=r).previousElementSibling;for(var l=c;l&&l.classList.contains("chatbot__item_bot");){for(var _=l.querySelectorAll(".chatbot__content"),h=0,p=_.length;h<p;h++)n[this._contentIndex]={type:"bot",content:_[h].innerHTML},this._contentIndex++;l=l.nextElementSibling}n[this._contentIndex]={type:"human",content:s},this._contentIndex++;var b,t=localStorage.getItem("chatbot"),d=[],e={};for(b in t&&(d=JSON.parse(t).data,e=JSON.parse(t).params),n)d.push({type:n[b].type,content:n[b].content});i&&(e[i]=s);e=JSON.stringify({botIndex:this._botIndex,data:d,params:e});localStorage.setItem("chatbot",e);e=JSON.stringify({id:localStorage.getItem(this._key),chat:n,start:this._start,date:getDateTime()});this._start=!1;var u=new XMLHttpRequest;u.onreadystatechange=function(){0!==u.readyState&&4!==u.readyState||u.status},u.open("POST",a),u.setRequestHeader("X-Requested-With","XMLHttpRequest"),u.setRequestHeader("Content-Type","application/json"),u.send(e)},SimpleChatbot.prototype._eventHandlerKeydown=function(t){var e=t.target;e.classList.contains("chatbot__input")&&(t=this._$root.querySelector(".chatbot__submit"),0<e.value.length?t.disabled=!1:t.disabled=!0)},SimpleChatbot.prototype._addEventListener=function(){this._$root.addEventListener("click",this._eventHandlerClick.bind(this)),this._$root.addEventListener("input",this._eventHandlerKeydown.bind(this)),this._$root.addEventListener("keypress",function(t){"Enter"===t.key&&t.target.classList.contains("chatbot__input")&&t.target.closest(".chatbot").querySelector(".chatbot__submit").click()})},SimpleChatbot.templateItem=function(t){let e='<div class="chatbot__item chatbot__item_{{type}}"><div class="chatbot__content chatbot__content_{{type}}{{state}}">{{content}}</div></div>';return e=e.replace("{{type}}",t.type),e=e.replace("{{type}}",t.type),e=e.replace("{{state}}","bot"===t.type?"":"-disabled"),e=e.replace("{{content}}",t.content),e},SimpleChatbot.resetTemplate=function(){let t=document.querySelector(".chatbot");t&&(t.innerHTML='<div class="chatbot__title"><span class="chatbot__close"></span>Chatbot<span class="chatbot__reset"></span></div><div class="chatbot__wrapper"><div class="chatbot__items"></div></div><div class="chatbot__footer"><input class="chatbot__input" type="text" disabled><button class="chatbot__submit" type="button" disabled></button></div>')},SimpleChatbot.createTemplate=function(){var t=document.querySelector(".chatbot");if(t)return t;const e=document.createElement("div");return e.className="chatbot chatbot_hidden",e.innerHTML='<div class="chatbot__title"><span class="chatbot__close"></span>Chatbot<span class="chatbot__reset"></span></div><div class="chatbot__wrapper"><div class="chatbot__items"></div></div><div class="chatbot__footer"><input class="chatbot__input" type="text" disabled><button class="chatbot__submit" type="button" disabled></button></div>',document.body.appendChild(e),document.querySelector(".chatbot")};